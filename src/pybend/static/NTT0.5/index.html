<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTTTX Schema Explorer</title>
    <link rel="stylesheet" href="./dark-theme.css">
    <link rel="stylesheet" href="./index.css">
    <style>

    </style>
</head>
<body>
    <div class="schema-explorer">
        <div class="explorer-header">
            <h1 class="explorer-title">üß† NTTTX Schema Explorer</h1>
            <p class="explorer-subtitle">Discover and explore backend schemas using the NTTTX framework</p>
            <div class="status-indicator status-ready" id="system-status">
                <span>üü¢</span> System Ready
            </div>
        </div>

        <!-- Model Input Section -->
        <div class="model-input-section">
            <div class="section-header">
                <span class="section-icon">üîç</span>
                Model Discovery
            </div>
            <div class="input-group">
                <div style="flex: 1;">
                    <label for="model-name" style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Model Name</label>
                    <input type="text" id="model-name" placeholder="e.g., users, products, bots" value="users">
                </div>
                <button id="fetch-btn" class="fetch-btn">
                    <span id="fetch-icon">üîç</span> Discover Schema
                </button>
            </div>
        </div>

        <!-- Schema Display Section -->
        <div class="schema-section">
            <div class="section-header">
                <span class="section-icon">üìê</span>
                Schema Definition
                <div style="margin-left: auto;">
                    <span class="status-indicator status-ready" id="schema-status">
                        <span>‚è≥</span> Waiting
                    </span>
                </div>
            </div>
            <div class="schema-display" id="schema-output">
                <div class="empty-state">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                    <div>Enter a model name and click "Discover Schema" to view the schema definition</div>
                </div>
            </div>
        </div>

        <!-- Items List Section -->
        <div class="items-section">
            <div class="section-header">
                <span class="section-icon">üì¶</span>
                Items (List View)
                <div style="margin-left: auto;">
                    <span class="status-indicator status-ready" id="list-status">
                        <span>‚è≥</span> Waiting
                    </span>
                </div>
            </div>
            <div class="component-container">
                <ucp-list id="items-container"></ucp-list>
            </div>
        </div>

        <!-- Items Table Section -->
        <div class="table-section">
            <div class="section-header">
                <span class="section-icon">üìä</span>
                Items (Table View)
                <div style="margin-left: auto;">
                    <span class="status-indicator status-ready" id="table-status">
                        <span>‚è≥</span> Waiting
                    </span>
                </div>
            </div>
            <div class="component-container">
                <ucp-table id="items-table"></ucp-table>
            </div>
        </div>
    </div>

    <!-- Import NTTTX Framework and Components -->
    <script type="module">
        // Import NTTTX Framework
        import { NTT, PTT } from './core/NTT.js';
        import { registrar, registry, dispatch } from './core/registrar.js';
        import { remote } from './core/Remote.js';
        import Event from './core/Event.js';
        import { config } from './config.js';

        // Import Web Components
        import './components/ntt-list.js';
        import './components/ntt-item.js';

        // Global framework access
        window.config = config;

        // Initialize Schema Explorer
        console.log('üß† NTTTX Schema Explorer initialized');

        updateSystemStatus('ready', 'System Ready');
    </script>



    <!-- This should display a create form for the Product model -->
    <!-- <ntt-item model="Product"></ntt-item> -->
    <!-- This should display a Product record -->
    <!-- <ntt-item model="Product", id="product-id"></ntt-item> -->
    <!-- This should display a list of items for the Product model -->
    <ntt-list model="Product"></ntt-list>

    <script>
        // Schema Explorer State
        let currentPTT = null;
        let currentSchema = null;
        let currentModel = null;
        let isLoading = false;

        // UI Element References
        const $modelInput = document.getElementById('model-name');
        const $fetchBtn = document.getElementById('fetch-btn');
        const $fetchIcon = document.getElementById('fetch-icon');
        const $schemaOutput = document.getElementById('schema-output');
        const $itemsContainer = document.getElementById('items-container');
        const $itemsTable = document.getElementById('items-table');

        // Status Update Functions
        function updateSystemStatus(type, message) {
            const $status = document.getElementById('system-status');
            $status.className = `status-indicator status-${type}`;

            const icons = { ready: 'üü¢', loading: 'üü°', error: 'üî¥' };
            $status.innerHTML = `<span>${icons[type]}</span> ${message}`;
        }

        function updateComponentStatus(component, type, message) {
            const $status = document.getElementById(`${component}-status`);
            $status.className = `status-indicator status-${type}`;

            const icons = { ready: '‚úÖ', loading: '‚è≥', error: '‚ùå' };
            $status.innerHTML = `<span>${icons[type]}</span> ${message}`;
        }

        // Enhanced JSON Tree Renderer
        function renderCollapsibleJSON(obj, level = 0) {
            if (typeof obj !== 'object' || obj === null) {
                return `<span class="schema-value">${JSON.stringify(obj)}</span>`;
            }

            const indent = '&nbsp;'.repeat(level * 2);
            const isArray = Array.isArray(obj);

            const entries = Object.entries(obj).map(([key, value]) => {
                const isObject = typeof value === 'object' && value !== null;
                const openAttr = level < 2 ? 'open' : ''; // Auto-open first 2 levels

                if (isObject) {
                    const nested = renderCollapsibleJSON(value, level + 1);
                    return `
                        ${indent}<details ${openAttr}>
                            <summary><span class="schema-key">${key}</span></summary>
                            ${nested}
                        </details>
                    `;
                } else {
                    const valueType = typeof value;
                    return `
                        ${indent}<div style="margin: 2px 0;">
                            <span class="schema-key">${key}</span>:
                            <span class="schema-value">${JSON.stringify(value)}</span>
                            <span class="schema-type">(${valueType})</span>
                        </div>
                    `;
                }
            });

            const wrapper = isArray ? ['[', ']'] : ['{', '}'];
            return `<div class="schema-tree">${wrapper[0]}<br>${entries.join('')}<br>${wrapper[1]}</div>`;
        }

        // Loading State Management
        function setLoadingState(loading) {
            isLoading = loading;
            $fetchBtn.disabled = loading;

            if (loading) {
                $fetchIcon.textContent = '‚è≥';
                $fetchBtn.innerHTML = '<span>‚è≥</span> Loading...';
                updateSystemStatus('loading', 'Loading Schema...');
            } else {
                $fetchIcon.textContent = 'üîç';
                $fetchBtn.innerHTML = '<span>üîç</span> Discover Schema';
                updateSystemStatus('ready', 'System Ready');
            }
        }

        // Error Display Functions
        function displayError(container, message) {
            container.innerHTML = `
                <div class="error-state">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ùå</div>
                    <div>${message}</div>
                </div>
            `;
        }

        function displayLoading(container, message = 'Loading...') {
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>${message}</div>
                </div>
            `;
        }

        // Schema Discovery Function
        async function discoverSchema() {
            const modelName = $modelInput.value.trim().toLowerCase();

            if (!modelName) {
                displayError($schemaOutput, 'Please enter a model name');
                updateComponentStatus('schema', 'error', 'No Model Name');
                return;
            }

            // Validate model name
            if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(modelName)) {
                displayError($schemaOutput, 'Model name must start with a letter and contain only letters, numbers, and underscores');
                updateComponentStatus('schema', 'error', 'Invalid Name');
                return;
            }

            currentModel = modelName;
            setLoadingState(true);

            // Reset component statuses
            updateComponentStatus('schema', 'loading', 'Fetching...');
            updateComponentStatus('list', 'loading', 'Waiting...');
            updateComponentStatus('table', 'loading', 'Waiting...');

            try {
                console.log(`üîç Discovering schema for: ${modelName}`);

                // Create PTT instance for schema discovery
                const pttAddr = `${modelName}_explorer`;
                const pttHref = `${config.API_URL}/${modelName}`;

                // Check if PTT already exists
                if (PTT.get && currentPTT) {
                    try {
                        // Clean up existing PTT
                        currentPTT = null;
                    } catch (e) {
                        console.warn('PTT cleanup warning:', e);
                    }
                }

                // Create new PTT instance
                currentPTT = PTT.register(pttAddr, pttHref);
                console.log(`‚úÖ Created PTT: ${pttAddr} -> ${pttHref}`);

                // Set up schema response handler
                const schemaResponseAddr = `${modelName}_schema_response`;
                registrar(schemaResponseAddr, (event) => {
                    console.log('üìê Schema response received:', event);
                    handleSchemaResponse(event);
                });

                // Set up items response handler
                const itemsResponseAddr = `${modelName}_items_response`;
                registrar(itemsResponseAddr, (event) => {
                    console.log('üì¶ Items response received:', event);
                    handleItemsResponse(event);
                });

                // Pull schema from remote
                displayLoading($schemaOutput, 'Fetching schema...');
                await currentPTT.pull();

                // Also fetch items list
                currentPTT.call('READ');

                // Set timeout for schema loading
                setTimeout(() => {
                    if (isLoading) {
                        setLoadingState(false);
                        displayError($schemaOutput, 'Schema loading timeout. Please check the backend connection.');
                        updateComponentStatus('schema', 'error', 'Timeout');
                    }
                }, 10000);

            } catch (error) {
                console.error('‚ùå Schema discovery failed:', error);
                setLoadingState(false);
                displayError($schemaOutput, `Failed to discover schema: ${error.message}`);
                updateComponentStatus('schema', 'error', 'Failed');
                updateComponentStatus('list', 'error', 'Failed');
                updateComponentStatus('table', 'error', 'Failed');
            }
        }

        // Schema Response Handler
        function handleSchemaResponse(event) {
            try {
                const schemaData = event.data || event;
                currentSchema = schemaData;

                console.log('üìê Processing schema data:', schemaData);

                // Display schema
                const schemaHTML = renderCollapsibleJSON(schemaData);
                $schemaOutput.innerHTML = schemaHTML;

                updateComponentStatus('schema', 'ready', 'Loaded');
                console.log('‚úÖ Schema displayed successfully');

                // Update components with schema
                updateWebComponents();

            } catch (error) {
                console.error('‚ùå Schema processing failed:', error);
                displayError($schemaOutput, `Failed to process schema: ${error.message}`);
                updateComponentStatus('schema', 'error', 'Process Failed');
            }
        }

        // Items Response Handler
        function handleItemsResponse(event) {
            try {
                const itemsData = event.data || event;
                console.log('üì¶ Processing items data:', itemsData);

                // Items are handled by the web components
                updateComponentStatus('list', 'ready', 'Loaded');
                updateComponentStatus('table', 'ready', 'Loaded');

                setLoadingState(false);
                console.log('‚úÖ Items loaded successfully');

            } catch (error) {
                console.error('‚ùå Items processing failed:', error);
                updateComponentStatus('list', 'error', 'Failed');
                updateComponentStatus('table', 'error', 'Failed');
                setLoadingState(false);
            }
        }

        // Update Web Components
        function updateWebComponents() {
            if (!currentSchema || !currentModel) return;

            try {
                const href = `${config.API_URL}/${currentModel}`;

                // Update list component
                $itemsContainer.setAttribute('href', href);
                $itemsContainer.prototype = currentSchema;

                // Update table component
                $itemsTable.setAttribute('href', href);
                $itemsTable.prototype = currentSchema;

                console.log('üîÑ Web components updated with schema');

            } catch (error) {
                console.error('‚ùå Component update failed:', error);
                updateComponentStatus('list', 'error', 'Update Failed');
                updateComponentStatus('table', 'error', 'Update Failed');
            }
        }

        // Event Listeners
        $fetchBtn.addEventListener('click', discoverSchema);

        $modelInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !isLoading) {
                discoverSchema();
            }
        });

        // Auto-discover on input change (debounced)
        let discoveryTimeout;
        $modelInput.addEventListener('input', () => {
            clearTimeout(discoveryTimeout);
            discoveryTimeout = setTimeout(() => {
                const value = $modelInput.value.trim();
                if (value && value !== currentModel && !isLoading) {
                    // Optional: auto-discover after 2 seconds of no typing
                    // discoverSchema();
                }
            }, 2000);
        });

        // Initialize
        console.log('üß† Schema Explorer UI initialized');
    </script>
</body>
</html>